clear; clc;

%% MDP Parameters
thrustLevels = [0, 25, 50, 75, 100];
n_states     = 100;
n_actions    = 10;    % 2 directions × 5 thrust levels
alpha        = 0.1;   % learning rate
gamma        = 0.95;  % discount factor
epsilon      = 0.2;   % exploration rate
n_episodes   = 1000;
max_steps    = 100;
sim_steps    = 300;   % simulation steps

%% States
% Columns: [x1, x2, psi, gamma, x1_dot, x2_dot, psi_dot, gamma_dot, psi_ddot, gamma_ddot]
states = [								
-322.418,137.978,8.144,36.406,-3.511,-6.198,-0.668,-1.589,0.031,-0.144;								
-326.049,131.384,7.507,34.673,-3.632,-6.594,-0.638,-1.733,0.034,-0.137;								
-329.753,124.401,6.903,32.804,-3.704,-6.983,-0.604,-1.87,0.032,-0.129;								
-333.478,117.025,6.33,30.805,-3.725,-7.376,-0.572,-1.999,0.026,-0.122;								
-337.174,109.247,5.783,28.684,-3.696,-7.779,-0.547,-2.121,0.017,-0.113;								
-340.789,101.051,5.254,26.45,-3.615,-8.196,-0.53,-2.234,0.007,-0.104;								
-344.27,92.425,4.731,24.112,-3.481,-8.626,-0.523,-2.338,-0.003,-0.095;								
-347.563,83.362,4.205,21.679,-3.293,-9.064,-0.526,-2.433,-0.012,-0.086;								
-350.617,73.862,3.666,19.16,-3.054,-9.5,-0.539,-2.519,-0.019,-0.076;								
-353.381,63.939,3.109,16.566,-2.764,-9.923,-0.558,-2.594,-0.023,-0.065;								
-355.808,53.621,2.527,13.906,-2.427,-10.318,-0.581,-2.66,-0.024,-0.055;								
-357.854,42.951,1.922,11.191,-2.046,-10.67,-0.605,-2.715,-0.022,-0.044;								
-359.481,31.987,1.295,8.432,-1.627,-10.964,-0.627,-2.759,-0.016,-0.033;								
-360.66,20.798,0.652,5.64,-1.178,-11.189,-0.643,-2.792,-0.009,-0.022;								
-361.367,1,0,2.826,-0.707,-11.334,-0.652,-2.814,0,-0.011;								
-361.589,-1.929,-0.652,0,-0.222,-11.394,-0.652,-2.826,0.009,0;								
-361.323,-13.297,-1.295,-2.826,0.266,-11.368,-0.643,-2.826,0.016,0.011;								
-360.575,-24.557,-1.922,-5.64,0.748,-11.26,-0.627,-2.814,0.022,0.022;								
-359.36,-35.633,-2.527,-8.432,1.216,-11.076,-0.605,-2.792,0.024,0.033;								
-357.7,-46.461,-3.109,-11.191,1.66,-10.828,-0.581,-2.759,0.023,0.044;								
-355.626,-56.988,-3.666,-13.906,2.074,-10.528,-0.558,-2.715,0.019,0.055;								
-353.174,-67.177,-4.205,-16.566,2.452,-10.189,-0.539,-2.66,0.012,0.065;								
-350.386,-77.004,-4.731,-19.16,2.788,-9.827,-0.526,-2.594,0.003,0.076;								
-347.307,-86.456,-5.254,-21.679,3.079,-9.451,-0.523,-2.519,-0.007,0.086;								
-343.984,-95.527,-5.783,-24.112,3.323,-9.072,-0.53,-2.433,-0.017,0.095;								
-340.468,-104.221,-6.33,-26.45,3.517,-8.694,-0.547,-2.338,-0.026,0.104;								
-336.808,-112.539,-6.903,-28.684,3.659,-8.318,-0.572,-2.234,-0.032,0.113;								
-333.059,-120.482,-7.507,-30.805,3.75,-7.943,-0.604,-2.121,-0.034,0.122;								
-329.272,-128.044,-8.144,-32.804,3.787,-7.562,-0.638,-1.999,-0.031,0.129;								
-325.501,-135.211,-8.813,-34.673,3.771,-7.167,-0.668,-1.87,-0.023,0.137;								
-321.8,-141.957,-9.504,-36.406,3.701,-6.746,-0.692,-1.733,-0.011,0.144;								
-318.225,-148.247,-10.207,-37.995,3.575,-6.29,-0.702,-1.589,0.006,0.15;								
-314.831,-154.035,-10.903,-39.434,3.393,-5.788,-0.696,-1.439,0.027,0.156;								
-311.677,-159.269,-11.572,-40.717,3.155,-5.234,-0.669,-1.283,0.049,0.161;								
-308.817,-163.892,-12.192,-41.84,2.86,-4.623,-0.62,-1.123,0.073,0.165;								
-306.307,-167.847,-12.74,-42.798,2.51,-3.955,-0.547,-0.958,0.095,0.169;								
-304.197,-171.08,-13.192,-43.586,2.11,-3.233,-0.453,-0.789,0.114,0.172;								
-302.532,-173.545,-13.531,-44.203,1.665,-2.465,-0.339,-0.617,0.129,0.174;								
-301.348,-175.208,-13.741,-44.645,1.184,-1.663,-0.21,-0.442,0.138,0.176;								
-300.67,-176.048,-13.813,-44.911,0.679,-0.84,-0.072,-0.266,0.141,0.177;								
-300.508,-176.058,-13.744,-45,0.161,-0.011,0.07,-0.089,0.138,0.178;								
-300.864,-175.25,-13.536,-44.911,-0.355,0.808,0.208,0.089,0.129,0.177;								
-301.722,-173.647,-13.199,-44.645,-0.858,1.603,0.337,0.266,0.114,0.176;								
-303.059,-171.288,-12.748,-44.203,-1.337,2.359,0.451,0.442,0.095,0.174;								
-304.841,-168.222,-12.203,-43.586,-1.782,3.067,0.546,0.617,0.073,0.172;								
-307.027,-164.502,-11.584,-42.798,-2.186,3.719,0.619,0.789,0.05,0.169;								
-309.574,-160.188,-10.915,-41.84,-2.547,4.314,0.669,0.958,0.027,0.165;								
-312.434,-155.336,-10.219,-40.717,-2.86,4.852,0.696,1.123,0.007,0.161;								
-315.559,-149.996,-9.517,-39.434,-3.125,5.34,0.703,1.283,-0.01,0.156;								
-318.901,-144.211,-8.824,-37.995,-3.342,5.785,0.692,1.439,-0.023,0.15;								
-322.413,-138.011,-8.156,-36.406,-3.512,6.2,0.669,1.589,-0.031,0.144;								
-326.045,-131.416,-7.517,-34.673,-3.632,6.596,0.638,1.733,-0.034,0.137;								
-329.749,-124.431,-6.913,-32.804,-3.704,6.985,0.605,1.87,-0.032,0.129;								
-333.475,-117.054,-6.34,-30.805,-3.726,7.377,0.573,1.999,-0.026,0.122;								
-337.172,-109.274,-5.793,-28.684,-3.696,7.78,0.547,2.121,-0.017,0.113;								
-340.787,-101.078,-5.263,-26.45,-3.615,8.196,0.53,2.234,-0.007,0.104;								
-344.267,-92.452,-4.74,-24.112,-3.481,8.626,0.523,2.338,0.003,0.095;								
-347.561,-83.389,-4.214,-21.679,-3.294,9.063,0.526,2.433,0.012,0.086;								
-350.615,-73.89,-3.676,-19.16,-3.054,9.499,0.538,2.519,0.019,0.076;								
-353.38,-63.968,-3.118,-16.566,-2.764,9.922,0.558,2.594,0.023,0.065;								
-355.807,-53.651,-2.538,-13.906,-2.427,10.316,0.581,2.66,0.024,0.055;								
-357.853,-42.983,-1.933,-11.191,-2.046,10.668,0.605,2.715,0.022,0.044;								
-359.48,-32.02,-1.306,-8.432,-1.628,10.963,0.627,2.759,0.016,0.033;								
-360.659,-20.832,-0.663,-5.64,-1.179,11.188,0.643,2.792,0.009,0.022;								
-361.367,-1,-0.011,-2.826,-0.707,11.333,0.652,2.814,0,0.011;								
-361.589,1.896,0.64,0,-0.223,11.394,0.652,2.826,-0.008,0;								
-361.324,13.265,1.284,2.826,0.265,11.369,0.643,2.826,-0.016,-0.011;								
-360.576,24.525,1.911,5.64,0.748,11.261,0.627,2.814,-0.021,-0.022;								
-359.361,35.602,2.517,8.432,1.215,11.077,0.606,2.792,-0.024,-0.033;								
-357.701,46.431,3.099,11.191,1.66,10.829,0.582,2.759,-0.023,-0.044;								
-355.628,56.96,3.657,13.906,2.074,10.529,0.558,2.715,-0.019,-0.055;								
-353.176,67.15,4.196,16.566,2.451,10.19,0.539,2.66,-0.013,-0.065;								
-350.389,76.977,4.722,19.16,2.788,9.827,0.526,2.594,-0.003,-0.076;								
-347.31,86.429,5.245,21.679,3.079,9.451,0.523,2.519,0.007,-0.086;								
-343.987,95.5,5.774,24.112,3.323,9.071,0.529,2.433,0.017,-0.095;								
-340.471,104.192,6.321,26.45,3.516,8.692,0.546,2.338,0.026,-0.104;								
-336.812,112.509,6.892,28.684,3.659,8.317,0.572,2.234,0.031,-0.113;								
-333.063,120.45,7.496,30.805,3.749,7.941,0.603,2.121,0.034,-0.122;								
-329.277,128.011,8.133,32.804,3.786,7.561,0.637,1.999,0.031,-0.129;								
-325.506,135.176,8.801,34.673,3.77,7.165,0.668,1.87,0.023,-0.137;								
-321.806,141.921,9.492,36.406,3.7,6.745,0.691,1.733,0.011,-0.144;								
-318.231,148.211,10.195,37.995,3.575,6.29,0.702,1.589,-0.006,-0.15;								
-314.838,154.001,10.891,39.434,3.393,5.789,0.696,1.439,-0.026,-0.156;								
-311.683,159.237,11.561,40.717,3.155,5.236,0.67,1.283,-0.049,-0.161;								
-308.823,163.863,12.182,41.84,2.86,4.626,0.621,1.123,-0.072,-0.165;								
-306.312,167.822,12.731,42.798,2.511,3.959,0.549,0.958,-0.094,-0.169;								
-304.202,171.06,13.185,43.586,2.111,3.238,0.455,0.789,-0.114,-0.172;								
-302.536,173.531,13.526,44.203,1.666,2.471,0.341,0.617,-0.129,-0.174;								
-301.35,175.201,13.739,44.645,1.186,1.67,0.213,0.442,-0.138,-0.176;								
-300.67,176.047,13.813,44.911,0.68,0.847,0.074,0.266,-0.141,-0.177;								
-300.507,176.065,13.746,45,0.163,0.018,-0.067,0.089,-0.138,-0.178;								
-300.86,175.264,13.541,44.911,-0.354,-0.802,-0.205,-0.089,-0.129,-0.177;								
-301.718,173.667,13.206,44.645,-0.857,-1.597,-0.335,-0.266,-0.114,-0.176;								
-303.053,171.313,12.757,44.203,-1.336,-2.354,-0.449,-0.442,-0.095,-0.174;								
-304.835,168.251,12.213,43.586,-1.781,-3.062,-0.544,-0.617,-0.073,-0.172;								
-307.021,164.535,11.595,42.798,-2.186,-3.716,-0.618,-0.789,-0.05,-0.169;								
-309.567,160.223,10.927,41.84,-2.547,-4.312,-0.668,-0.958,-0.028,-0.165;								
-312.427,155.372,10.231,40.717,-2.86,-4.851,-0.696,-1.123,-0.007,-0.161;								
-315.553,150.032,9.529,39.434,-3.126,-5.34,-0.703,-1.283,0.01,-0.156;								
-318.896,144.246,8.836,37.995,-3.343,-5.786,-0.692,-1.439,0.023,-0.15											
];

%% Derive sway direction
% 1 = up, 2 = down
x2_dot = states(:,6);
x2_dir = ones(n_states,1);
x2_dir(x2_dot < 0) = 2;

%% Deactivation Map
deactMap = cell(n_states,1);
deactMap{65} = [1:14,16:64,66:100];
deactMap{66} = [1:13,17:63,67:100];
deactMap{67} = [1:12,18:62,68:100];
deactMap{68} = [1:11,19:61,69:100];
deactMap{69} = [1:10,20:60,70:100];
deactMap{70} = [1:9,21:59,71:100];
deactMap{71} = [1:8,22:58,72:100];
deactMap{72} = [1:7,23:57,73:100];
deactMap{73} = [1:6,24:56,74:100];
deactMap{74} = [1:5,25:55,75:100];
deactMap{75} = [1:4,26:54,76:100];
deactMap{76} = [1:3,27:53,77:100];
deactMap{77} = [1:2,28:52,78:100];
deactMap{78} = [1,29:51,79:100];
deactMap{79} = [30:49,80:100];
deactMap{80} = [31:49,81:100];
deactMap{81} = [32:45,82:100];
deactMap{82} = [33:44,83:100];
deactMap{83} = [34:43,84:100];
deactMap{84} = [35:42,85:100];
deactMap{85} = [36:41,86:100];
deactMap{86} = [37:40,87:100];
deactMap{87} = [38:42,88:92];
deactMap{88} = [39:41,89:91];
deactMap{89} = [40,90];
% mirror into states S15–S39
for k=0:24
    deactMap{15+k} = deactMap{65+k};
end


%% Real Parameters
parameters.fpso.length    = 360;
parameters.fpso.BowX0     = 0;
parameters.fpso.BowY0     = 0;
parameters.shuttle.length = 320;
parameters.shuttle.beam   = 54.5;
parameters.shuttle.draft  = 21.4;
parameters.shuttle.cgx    = 0.55;
parameters.shuttle.cgy    = 0.5;
parameters.shuttle.s      = 27340;
parameters.shuttle.cb     = 0.83;
parameters.shuttle.cy     = 0.86;
parameters.shuttle.lp     = 0.05 * parameters.shuttle.length;
parameters.shuttle.m      = 3.219 * 10^8;
parameters.shuttle.iz     = 2.06*10^12;
parameters.shuttle.m11    = 1.848*10^7;
parameters.shuttle.m22    = 2.725*10^8;
parameters.shuttle.m66    = 1.579*10^12;
parameters.shuttle.m26    = 2.209*10^9;
parameters.shuttle.lBow   = parameters.shuttle.length * parameters.shuttle.cgx;
parameters.hawser.length  = 0.6*parameters.shuttle.length;
parameters.hawser.X0      = 0;
parameters.hawser.Y0      = 0;
parameters.shuttle.CGX0   = -(parameters.hawser.X0 + parameters.hawser.length*cos(deg2rad(45)) + parameters.shuttle.lBow);
parameters.shuttle.CGY0   = parameters.hawser.length*sin(deg2rad(45));
parameters.time.dt        = 1;
parameters.water.rho      = 1025;
parameters.water.mu       = 1e-3;
parameters.current.vc     = 4.74;
parameters.current.alphac = 180; 
parameters.rudder.AR      = 250;
parameters.rudder.wP0     = 0.20;
parameters.rudder.yP      = 5;
parameters.rudder.nP      = 1.5;
parameters.rudder.DP      = 8;
parameters.rudder.k0      = 0.15;
parameters.rudder.k1      = -0.25;
parameters.rudder.k2      = 0.12;
parameters.rudder.xP      = -140;
parameters.rudder.yR      = 5;
parameters.rudder.aH      = 0.10;
parameters.rudder.gammaR  = 0.80;
parameters.rudder.lR      = 2 * parameters.rudder.xP;
parameters.rudder.eta     = 0.55;
parameters.rudder.kappa   = 0.20;
parameters.rudder.eps     = 0.80;
parameters.rudder.Lambda  = 1.60;

%% Save Parameters
save('main_params.mat', 'thrustLevels', 'n_states', 'n_actions', ...
    'alpha', 'gamma', 'epsilon', 'n_episodes', 'max_steps', 'sim_steps', ...
    'states', 'x2_dir', 'deactMap', 'parameters');

%% Mode Selection
fprintf('Select mode:\n 1 - Train\n 2 - Simulate\n');
choice = input('Enter choice: ');
switch choice
    case 1
        training;
    case 2
        simulation;
end
